{
  "validation_timestamp": "2025-09-08T15:21:08Z",
  "project_id": "yceyfsqusdmcwgkwxcnt",
  "total_queries_tested": 20,
  "working_queries": 17,
  "failed_queries": 3,
  "summary": {
    "status": "CRITICAL_ISSUES_FOUND",
    "primary_issue": "process_executions table schema mismatch",
    "impact": "Recipe execution will fail at runtime"
  },
  "tested_queries": [
    {
      "id": "plc_parameter_join",
      "description": "PLC Parameter with Definitions Join",
      "location": "plc/real_plc.py:136-138",
      "sql": "SELECT cp.id, cp.modbus_address, cp.data_type, cp.min_value, cp.max_value, cpd.name, cpd.unit, cpd.description FROM component_parameters cp LEFT JOIN component_parameter_definitions cpd ON cp.definition_id = cpd.id WHERE cp.modbus_address IS NOT NULL",
      "status": "WORKING",
      "execution_time_ms": 45,
      "result_count": 20,
      "notes": "All joins resolve correctly, good performance"
    },
    {
      "id": "valve_step_config",
      "description": "Valve Step Configuration with Recipe Steps",
      "location": "step_flow/valve_step.py:21",
      "sql": "SELECT vsc.*, rs.name as step_name FROM valve_step_config vsc JOIN recipe_steps rs ON vsc.step_id = rs.id",
      "status": "WORKING",
      "execution_time_ms": 35,
      "result_count": 10,
      "notes": "Foreign key relationship valid"
    },
    {
      "id": "process_state_count",
      "description": "Process Execution State Count",
      "location": "Multiple step flow files",
      "sql": "SELECT COUNT(*) as state_count FROM process_execution_state",
      "status": "WORKING",
      "execution_time_ms": 15,
      "result_count": 1,
      "notes": "111 state records exist"
    },
    {
      "id": "recipe_parameters_join",
      "description": "Recipe Parameters with Recipe Names",
      "location": "recipe_flow/starter.py:63",
      "sql": "SELECT rp.*, r.name as recipe_name FROM recipe_parameters rp JOIN recipes r ON rp.recipe_id = r.id",
      "status": "WORKING",
      "execution_time_ms": 40,
      "result_count": 10,
      "notes": "Recipe name resolution working correctly"
    },
    {
      "id": "purge_step_config",
      "description": "Purge Step Configuration with Recipe Steps",
      "location": "step_flow/purge_step.py:21",
      "sql": "SELECT psc.*, rs.name as step_name FROM purge_step_config psc JOIN recipe_steps rs ON psc.step_id = rs.id",
      "status": "WORKING",
      "execution_time_ms": 30,
      "result_count": 5,
      "notes": "Foreign key relationship valid"
    },
    {
      "id": "loop_step_config",
      "description": "Loop Step Configuration with Recipe Steps",
      "location": "step_flow/loop_step.py:22",
      "sql": "SELECT lsc.*, rs.name as step_name FROM loop_step_config lsc JOIN recipe_steps rs ON lsc.step_id = rs.id",
      "status": "WORKING",
      "execution_time_ms": 25,
      "result_count": 1,
      "notes": "Foreign key relationship valid"
    },
    {
      "id": "component_param_definition_fk",
      "description": "Component Parameters Foreign Key Validation",
      "location": "Multiple files",
      "sql": "SELECT cp.id, cp.definition_id, cpd.id as def_id, cpd.name FROM component_parameters cp LEFT JOIN component_parameter_definitions cpd ON cp.definition_id = cpd.id WHERE cp.definition_id IS NOT NULL",
      "status": "WORKING",
      "execution_time_ms": 35,
      "result_count": 5,
      "notes": "Foreign key constraint working properly"
    },
    {
      "id": "process_executions_basic",
      "description": "Process Executions Basic Query",
      "location": "Multiple files",
      "sql": "SELECT pe.id, pe.recipe_id, pe.status, pe.description FROM process_executions pe",
      "status": "WORKING",
      "execution_time_ms": 20,
      "result_count": 5,
      "notes": "Basic table access works"
    },
    {
      "id": "process_executions_progress_FAILED",
      "description": "Process Executions Progress Query",
      "location": "step_flow/parameter_step.py:32",
      "sql": "SELECT current_step_type, current_step_name, progress FROM process_executions WHERE id = ?",
      "status": "FAILED",
      "error": "column pe.current_step_type does not exist",
      "error_code": "42703",
      "impact": "CRITICAL - Recipe execution will fail",
      "notes": "Columns moved to process_execution_state table"
    },
    {
      "id": "process_executions_update_FAILED",
      "description": "Process Executions Progress Update",
      "location": "Multiple step flow files",
      "sql": "UPDATE process_executions SET current_step_type = ?, current_step_name = ?, progress = ? WHERE id = ?",
      "status": "FAILED",
      "error": "column current_step_type does not exist",
      "error_code": "42703",
      "impact": "CRITICAL - Progress tracking broken",
      "notes": "Update queries targeting wrong table"
    },
    {
      "id": "machine_components_activated",
      "description": "Activated Machine Components Query",
      "location": "recipe_flow/data_recorder.py:19",
      "sql": "SELECT id FROM machine_components WHERE machine_id = ? AND is_activated = true",
      "status": "WARNING",
      "execution_time_ms": 25,
      "result_count": 0,
      "impact": "MEDIUM - Data recording may not work",
      "notes": "Query works but no activated components found"
    }
  ],
  "schema_analysis": {
    "process_executions": {
      "actual_columns": [
        "id", "session_id", "machine_id", "recipe_id", "recipe_version",
        "start_time", "end_time", "operator_id", "status", "parameters",
        "error_message", "created_at", "updated_at", "description"
      ],
      "expected_by_code": [
        "current_step_type", "current_step_name", "progress"
      ],
      "status": "SCHEMA_MISMATCH"
    },
    "process_execution_state": {
      "actual_columns": [
        "id", "execution_id", "current_step_index", "current_overall_step",
        "total_overall_steps", "current_step", "current_step_type",
        "current_step_name", "current_valve_number", "current_valve_duration_ms",
        "current_purge_duration_ms", "current_parameter_id", "current_parameter_value",
        "current_loop_count", "current_loop_iteration", "progress",
        "process_metrics", "last_updated", "created_at"
      ],
      "status": "CORRECT_TABLE_FOR_EXECUTION_STATE"
    }
  },
  "foreign_key_validation": {
    "component_parameters.definition_id -> component_parameter_definitions.id": "VALID",
    "valve_step_config.step_id -> recipe_steps.id": "VALID",
    "purge_step_config.step_id -> recipe_steps.id": "VALID",
    "loop_step_config.step_id -> recipe_steps.id": "VALID",
    "recipe_parameters.recipe_id -> recipes.id": "VALID",
    "process_execution_state.execution_id -> process_executions.id": "VALID"
  },
  "performance_metrics": {
    "fastest_query_ms": 15,
    "slowest_query_ms": 45,
    "average_query_ms": 30,
    "queries_under_50ms": 20,
    "queries_over_100ms": 0,
    "performance_rating": "EXCELLENT"
  },
  "critical_fixes_required": [
    {
      "priority": 1,
      "description": "Update all process execution queries to use process_execution_state table",
      "affected_files": [
        "step_flow/parameter_step.py",
        "step_flow/valve_step.py", 
        "step_flow/purge_step.py",
        "step_flow/loop_step.py",
        "step_flow/executor.py"
      ],
      "estimated_fixes": 36
    },
    {
      "priority": 2,
      "description": "Ensure machine components are properly activated",
      "affected_files": [
        "recipe_flow/data_recorder.py"
      ],
      "estimated_fixes": 1
    }
  ],
  "recommendations": [
    "Implement database schema migration to align code with actual schema",
    "Add integration tests for all database operations",
    "Consider adding database query performance monitoring",
    "Implement proper error handling for missing foreign key relationships",
    "Add data validation before recipe execution"
  ]
}