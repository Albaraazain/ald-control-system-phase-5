{
  "project": "ALD Control System PLC Testing UI",
  "version": "1.0",
  "architect": "Claude Streamlit UI Specialist",
  "created": "2025-09-09",
  
  "system_analysis": {
    "existing_architecture": {
      "plc_interface": {
        "abstract_class": "PLCInterface (src/plc/interface.py)",
        "implementations": ["RealPLC", "SimulationPLC"],
        "manager": "PLCManager (singleton pattern)",
        "communicator": "PLCCommunicator (Modbus TCP)",
        "factory": "PLCFactory for instance creation"
      },
      "core_operations": {
        "connection": ["initialize()", "disconnect()", "is_connected()"],
        "parameter_ops": ["read_parameter(id)", "write_parameter(id, value)", "read_all_parameters()"],
        "valve_control": ["control_valve(number, state, duration_ms)"],
        "purge_ops": ["execute_purge(duration_ms)"],
        "data_types": ["float", "int32", "int16", "binary"],
        "modbus_types": ["holding_register", "input_register", "coil", "discrete_input"]
      },
      "data_sources": {
        "supabase_integration": "component_parameters table",
        "parameter_metadata": "name, modbus_address, data_type, min/max values, is_writable",
        "valve_mappings": "extracted from component names (Valve 1, Valve 2, etc.)",
        "scaling_parameters": "MFC and pressure gauge voltage scaling"
      }
    }
  },

  "ui_design": {
    "layout_structure": {
      "type": "sidebar_navigation",
      "rationale": "Allows multiple functional areas while maintaining context",
      "main_layout": {
        "sidebar": {
          "width": "300px",
          "sections": [
            "Connection Panel",
            "Navigation Menu", 
            "System Status Summary",
            "Quick Actions"
          ]
        },
        "main_content": {
          "dynamic_content": "Changes based on sidebar selection",
          "areas": [
            "Parameter Browser",
            "Valve Control Center", 
            "Purge Operations",
            "Debug Console",
            "Batch Operations",
            "Live Logs"
          ]
        }
      }
    },

    "component_specifications": {
      "connection_panel": {
        "location": "Sidebar top",
        "components": [
          {
            "type": "expander",
            "title": "PLC Connection",
            "contents": [
              {
                "type": "text_input", 
                "label": "PLC IP Address",
                "key": "plc_ip",
                "default": "192.168.1.100"
              },
              {
                "type": "number_input",
                "label": "Port",
                "key": "plc_port", 
                "default": 502,
                "min_value": 1,
                "max_value": 65535
              },
              {
                "type": "text_input",
                "label": "Hostname (optional)",
                "key": "plc_hostname",
                "help": "e.g., plc.local for DHCP environments"
              },
              {
                "type": "checkbox",
                "label": "Enable Auto-Discovery",
                "key": "auto_discover",
                "help": "Scan network if hostname fails"
              },
              {
                "type": "columns",
                "layout": [0.5, 0.5],
                "contents": [
                  {
                    "type": "button",
                    "label": "Connect",
                    "key": "btn_connect",
                    "variant": "primary"
                  },
                  {
                    "type": "button", 
                    "label": "Disconnect",
                    "key": "btn_disconnect",
                    "variant": "secondary"
                  }
                ]
              }
            ]
          }
        ]
      },

      "system_status_dashboard": {
        "location": "Sidebar middle", 
        "components": [
          {
            "type": "status_indicator",
            "label": "Connection Status",
            "states": ["üî¥ Disconnected", "üü¢ Connected", "üü° Connecting", "‚ö†Ô∏è Error"]
          },
          {
            "type": "metric_display",
            "label": "Parameters Loaded",
            "format": "{count} parameters"
          },
          {
            "type": "metric_display", 
            "label": "Valves Available",
            "format": "{count} valves"
          },
          {
            "type": "error_display",
            "label": "Last Error",
            "max_length": 50
          }
        ]
      },

      "parameter_browser": {
        "location": "Main content area",
        "layout": {
          "type": "three_column",
          "proportions": [0.4, 0.35, 0.25],
          "columns": [
            {
              "title": "Parameter List",
              "components": [
                {
                  "type": "search_box",
                  "label": "Search Parameters",
                  "key": "param_search",
                  "help": "Search by name, component, or ID"
                },
                {
                  "type": "selectbox",
                  "label": "Filter by Component",
                  "key": "component_filter",
                  "options": ["All", "MFC", "Valve", "Pressure Gauge", "Temperature", "Custom"]
                },
                {
                  "type": "selectbox", 
                  "label": "Filter by Type",
                  "key": "type_filter",
                  "options": ["All", "Readable", "Writable", "Binary", "Numeric"]
                },
                {
                  "type": "dataframe",
                  "key": "parameter_table",
                  "columns": ["Name", "Component", "Type", "Current Value"],
                  "selection_mode": "single-row",
                  "height": 400
                }
              ]
            },
            {
              "title": "Parameter Details",
              "components": [
                {
                  "type": "info_panel",
                  "fields": [
                    "Parameter ID",
                    "Name", 
                    "Component Name",
                    "Data Type",
                    "Modbus Address",
                    "Modbus Type",
                    "Min Value",
                    "Max Value",
                    "Is Writable",
                    "Description",
                    "Unit"
                  ]
                },
                {
                  "type": "value_display",
                  "label": "Current Value",
                  "format": "large_text_with_unit"
                },
                {
                  "type": "button",
                  "label": "Read Current Value",
                  "key": "btn_read_single",
                  "variant": "secondary"
                }
              ]
            },
            {
              "title": "Write Operations",
              "components": [
                {
                  "type": "conditional_display",
                  "condition": "parameter_is_writable",
                  "contents": [
                    {
                      "type": "number_input",
                      "label": "New Value",
                      "key": "write_value",
                      "help": "Value to write to parameter"
                    },
                    {
                      "type": "button",
                      "label": "Write Value",
                      "key": "btn_write_value",
                      "variant": "primary"
                    }
                  ]
                },
                {
                  "type": "conditional_display", 
                  "condition": "parameter_not_writable",
                  "contents": [
                    {
                      "type": "info",
                      "message": "This parameter is read-only",
                      "icon": "info"
                    }
                  ]
                },
                {
                  "type": "text_area",
                  "label": "Operation Log",
                  "key": "operation_log",
                  "height": 200,
                  "disabled": true
                }
              ]
            }
          ]
        }
      },

      "valve_control_center": {
        "location": "Main content area",
        "layout": {
          "type": "two_column",
          "proportions": [0.6, 0.4],
          "columns": [
            {
              "title": "Valve Grid Control",
              "components": [
                {
                  "type": "valve_grid",
                  "description": "Dynamic grid of available valves",
                  "valve_component": {
                    "type": "valve_card",
                    "contents": [
                      {
                        "type": "title", 
                        "format": "Valve {number}"
                      },
                      {
                        "type": "status_indicator",
                        "states": ["üî¥ Closed", "üü¢ Open", "üü° Operating", "‚ùå Error"]
                      },
                      {
                        "type": "button_group",
                        "buttons": [
                          {
                            "label": "Open",
                            "key": "btn_open_{valve_num}",
                            "variant": "primary"
                          },
                          {
                            "label": "Close", 
                            "key": "btn_close_{valve_num}",
                            "variant": "secondary"
                          }
                        ]
                      },
                      {
                        "type": "expander",
                        "title": "Timed Operation",
                        "contents": [
                          {
                            "type": "number_input",
                            "label": "Duration (ms)",
                            "key": "duration_{valve_num}",
                            "min_value": 100,
                            "max_value": 60000,
                            "default": 5000
                          },
                          {
                            "type": "button",
                            "label": "Open with Timer",
                            "key": "btn_timed_{valve_num}",
                            "variant": "primary"
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            },
            {
              "title": "Batch Valve Operations",
              "components": [
                {
                  "type": "multiselect",
                  "label": "Select Valves",
                  "key": "batch_valves",
                  "help": "Choose multiple valves for batch operations"
                },
                {
                  "type": "button_group",
                  "layout": "vertical",
                  "buttons": [
                    {
                      "label": "Open Selected",
                      "key": "btn_batch_open",
                      "variant": "primary"
                    },
                    {
                      "label": "Close Selected", 
                      "key": "btn_batch_close",
                      "variant": "secondary"
                    },
                    {
                      "label": "Close All Valves",
                      "key": "btn_close_all",
                      "variant": "secondary"
                    }
                  ]
                },
                {
                  "type": "separator"
                },
                {
                  "type": "info",
                  "message": "Valve Status Legend",
                  "details": [
                    "üü¢ Open - Valve is currently open",
                    "üî¥ Closed - Valve is currently closed", 
                    "üü° Operating - Valve operation in progress",
                    "‚ùå Error - Communication error"
                  ]
                }
              ]
            }
          ]
        }
      },

      "purge_operations": {
        "location": "Main content area",
        "components": [
          {
            "type": "container",
            "title": "Purge System Control",
            "contents": [
              {
                "type": "columns",
                "layout": [0.4, 0.6],
                "contents": [
                  {
                    "type": "number_input",
                    "label": "Purge Duration (ms)",
                    "key": "purge_duration",
                    "min_value": 100,
                    "max_value": 300000,
                    "default": 10000,
                    "help": "Duration for purge operation in milliseconds"
                  },
                  {
                    "type": "progress_indicator",
                    "label": "Purge Progress", 
                    "key": "purge_progress",
                    "format": "Time remaining: {remaining}ms"
                  }
                ]
              },
              {
                "type": "button_group",
                "buttons": [
                  {
                    "label": "Start Purge",
                    "key": "btn_start_purge",
                    "variant": "primary",
                    "size": "large"
                  },
                  {
                    "label": "Emergency Stop",
                    "key": "btn_stop_purge", 
                    "variant": "secondary",
                    "size": "large"
                  }
                ]
              },
              {
                "type": "status_display",
                "label": "Purge Status",
                "states": ["Ready", "Running", "Completing", "Error"]
              }
            ]
          }
        ]
      },

      "debug_console": {
        "location": "Main content area",
        "components": [
          {
            "type": "expander",
            "title": "Low-Level Modbus Operations",
            "expanded": true,
            "contents": [
              {
                "type": "columns",
                "layout": [0.25, 0.25, 0.25, 0.25],
                "contents": [
                  {
                    "type": "number_input",
                    "label": "Address", 
                    "key": "modbus_address",
                    "min_value": 0,
                    "max_value": 65535
                  },
                  {
                    "type": "selectbox",
                    "label": "Type",
                    "key": "modbus_type",
                    "options": ["holding", "input", "coil", "discrete_input"]
                  },
                  {
                    "type": "selectbox", 
                    "label": "Data Type",
                    "key": "modbus_data_type",
                    "options": ["int16", "int32", "float", "binary"]
                  },
                  {
                    "type": "number_input",
                    "label": "Count",
                    "key": "modbus_count",
                    "min_value": 1,
                    "max_value": 100,
                    "default": 1
                  }
                ]
              },
              {
                "type": "button_group",
                "buttons": [
                  {
                    "label": "Read Raw",
                    "key": "btn_read_raw",
                    "variant": "secondary"
                  },
                  {
                    "label": "Write Raw", 
                    "key": "btn_write_raw",
                    "variant": "primary"
                  }
                ]
              },
              {
                "type": "conditional_display",
                "condition": "write_operation",
                "contents": [
                  {
                    "type": "text_input",
                    "label": "Value to Write",
                    "key": "raw_write_value"
                  }
                ]
              }
            ]
          },
          {
            "type": "text_area",
            "label": "Debug Output",
            "key": "debug_output",
            "height": 300,
            "disabled": true,
            "help": "Low-level Modbus communication results"
          }
        ]
      },

      "batch_operations": {
        "location": "Main content area",
        "components": [
          {
            "type": "container",
            "title": "Bulk Parameter Operations",
            "contents": [
              {
                "type": "button_group",
                "layout": "horizontal",
                "buttons": [
                  {
                    "label": "Read All Parameters",
                    "key": "btn_read_all",
                    "variant": "primary"
                  },
                  {
                    "label": "Export to CSV",
                    "key": "btn_export_csv", 
                    "variant": "secondary"
                  },
                  {
                    "label": "Import from CSV",
                    "key": "btn_import_csv",
                    "variant": "secondary"
                  }
                ]
              },
              {
                "type": "progress_bar",
                "label": "Batch Operation Progress",
                "key": "batch_progress"
              },
              {
                "type": "dataframe",
                "label": "Bulk Results",
                "key": "batch_results_table",
                "height": 400,
                "columns": ["Parameter", "Component", "Value", "Status", "Timestamp"]
              }
            ]
          }
        ]
      },

      "live_logs": {
        "location": "Main content area",
        "components": [
          {
            "type": "container",
            "title": "System Logs & Monitoring",
            "contents": [
              {
                "type": "columns",
                "layout": [0.3, 0.3, 0.4],
                "contents": [
                  {
                    "type": "selectbox", 
                    "label": "Log Level",
                    "key": "log_level_filter",
                    "options": ["All", "DEBUG", "INFO", "WARNING", "ERROR"]
                  },
                  {
                    "type": "checkbox",
                    "label": "Auto-refresh",
                    "key": "auto_refresh_logs",
                    "default": true
                  },
                  {
                    "type": "button",
                    "label": "Clear Logs",
                    "key": "btn_clear_logs",
                    "variant": "secondary"
                  }
                ]
              },
              {
                "type": "text_area",
                "label": "Live Log Output",
                "key": "live_logs_display",
                "height": 500,
                "disabled": true,
                "help": "Real-time system and PLC communication logs"
              }
            ]
          }
        ]
      }
    }
  },

  "state_management": {
    "session_state_variables": {
      "connection_state": {
        "key": "plc_connected",
        "type": "boolean",
        "default": false,
        "description": "PLC connection status"
      },
      "plc_manager": {
        "key": "plc_manager_instance", 
        "type": "object",
        "default": null,
        "description": "Cached PLC manager instance"
      },
      "parameters_cache": {
        "key": "loaded_parameters",
        "type": "dict",
        "default": {},
        "description": "Cached parameter metadata"
      },
      "valves_cache": {
        "key": "loaded_valves",
        "type": "dict", 
        "default": {},
        "description": "Cached valve mappings"
      },
      "selected_parameter": {
        "key": "current_parameter",
        "type": "string",
        "default": null,
        "description": "Currently selected parameter ID"
      },
      "operation_logs": {
        "key": "ui_logs",
        "type": "list",
        "default": [],
        "description": "UI operation history"
      },
      "purge_status": {
        "key": "purge_active",
        "type": "dict",
        "default": {"active": false, "start_time": null, "duration": 0},
        "description": "Purge operation state"
      }
    },

    "caching_strategy": {
      "parameter_metadata": {
        "cache_key": "parameter_cache",
        "refresh_trigger": "connection_established",
        "ttl": "session",
        "invalidate_on": ["disconnect"]
      },
      "valve_mappings": {
        "cache_key": "valve_cache",
        "refresh_trigger": "connection_established", 
        "ttl": "session",
        "invalidate_on": ["disconnect"]
      },
      "real_time_values": {
        "cache_key": "live_values",
        "refresh_trigger": "manual_read",
        "ttl": "30_seconds",
        "invalidate_on": ["parameter_write", "time_expiry"]
      }
    }
  },

  "integration_strategy": {
    "plc_interface_usage": {
      "initialization": {
        "method": "Use PLCManager singleton pattern",
        "implementation": "from src.plc.manager import plc_manager",
        "async_handling": "Use asyncio.run() for async operations in Streamlit callbacks"
      },
      "connection_management": {
        "connect_flow": [
          "Validate input parameters (IP, port, hostname)",
          "Call plc_manager.initialize(plc_type='real', config=user_config)",
          "Update connection status in session state",
          "Load parameter and valve metadata",
          "Enable UI controls"
        ],
        "disconnect_flow": [
          "Call plc_manager.disconnect()",
          "Clear cached data",
          "Update UI state to disconnected", 
          "Disable dependent controls"
        ]
      },
      "parameter_operations": {
        "read_single": "await plc_manager.read_parameter(parameter_id)",
        "write_single": "await plc_manager.write_parameter(parameter_id, value)",
        "read_bulk": "await plc_manager.read_all_parameters()",
        "error_handling": "Try/catch with user-friendly error messages"
      },
      "valve_operations": {
        "single_valve": "await plc_manager.control_valve(valve_num, state, duration)",
        "batch_valves": "Iterate through selected valves with error aggregation",
        "status_tracking": "Read valve state parameters for status display"
      }
    },

    "async_handling_pattern": {
      "streamlit_async": {
        "approach": "Use asyncio.run() in button callbacks",
        "example": "if st.button('Read'): asyncio.run(read_parameter_async(param_id))",
        "error_handling": "Wrap in try/catch, display errors in st.error()"
      },
      "background_tasks": {
        "purge_operations": "Use asyncio.create_task() for timed operations",
        "progress_tracking": "Update session state from async callbacks",
        "log_streaming": "Periodic refresh of log displays"
      }
    }
  },

  "technical_implementation": {
    "file_structure": {
      "main_app": "streamlit_plc_tester.py",
      "page_modules": {
        "pages/connection.py": "Connection management page",
        "pages/parameters.py": "Parameter browser and operations", 
        "pages/valves.py": "Valve control interface",
        "pages/purge.py": "Purge operations",
        "pages/debug.py": "Low-level debugging tools",
        "pages/batch.py": "Bulk operations",
        "pages/logs.py": "Live logging display"
      },
      "utility_modules": {
        "utils/async_helpers.py": "Asyncio utilities for Streamlit",
        "utils/ui_components.py": "Reusable UI components",
        "utils/data_formatters.py": "Data display formatting",
        "utils/error_handlers.py": "Error handling utilities"
      }
    },

    "key_libraries": {
      "streamlit": "^1.28.0 - Main UI framework",
      "asyncio": "Built-in - Async operation handling", 
      "pandas": "^2.0.0 - Data manipulation for tables",
      "plotly": "^5.15.0 - Interactive charts (optional)",
      "streamlit-aggrid": "^0.3.4 - Enhanced data grids"
    },

    "performance_considerations": {
      "connection_pooling": "Reuse PLC manager instance across pages",
      "data_caching": "Cache parameter metadata, refresh only on reconnection",
      "async_operations": "Non-blocking UI during PLC operations",
      "memory_management": "Limit log buffer size, rotate old entries",
      "ui_responsiveness": "Use st.empty() containers for dynamic updates"
    }
  },

  "user_experience_flow": {
    "initial_setup": [
      "Launch Streamlit app",
      "Navigate to Connection page via sidebar", 
      "Enter PLC connection details (IP/hostname/port)",
      "Click Connect button",
      "Verify successful connection in status panel",
      "Navigate to desired testing area"
    ],

    "parameter_testing_workflow": [
      "Go to Parameter Browser page",
      "Use search/filter to find specific parameters",
      "Select parameter from table",
      "View detailed information in info panel",
      "For writable parameters: enter new value and write",
      "Monitor operation results in log panel"
    ],

    "valve_testing_workflow": [
      "Navigate to Valve Control page",
      "See grid of available valves with current status",
      "Click individual Open/Close buttons for single valve control",
      "Use timed operations for automated valve sequences", 
      "Use batch operations for multiple valve control",
      "Monitor valve status indicators for feedback"
    ],

    "debugging_workflow": [
      "Go to Debug Console page",
      "Enter raw Modbus address and type",
      "Perform low-level read/write operations",
      "Examine results in debug output area",
      "Use for troubleshooting parameter mappings"
    ]
  },

  "error_handling_strategy": {
    "connection_errors": {
      "display": "Clear error messages in red alert boxes",
      "recovery": "Automatic retry options with backoff",
      "logging": "Log to both UI and system logs"
    },
    "parameter_errors": {
      "validation": "Client-side range checking before write operations",
      "plc_errors": "Display Modbus exception details",
      "timeout_handling": "Configurable timeout with user feedback"
    },
    "ui_resilience": {
      "graceful_degradation": "Disable controls when disconnected",
      "state_preservation": "Maintain UI state during temporary errors",
      "user_feedback": "Progress indicators for long operations"
    }
  },

  "testing_and_validation": {
    "manual_testing": [
      "Connection to real PLC hardware",
      "Connection to PLC simulator",
      "Parameter read/write validation",
      "Valve operation verification",
      "Error condition handling",
      "UI responsiveness under load"
    ],
    "automated_testing": [
      "Unit tests for utility functions", 
      "Integration tests with mock PLC",
      "UI component testing with pytest-streamlit",
      "Error simulation testing"
    ]
  },

  "security_considerations": {
    "input_validation": "Sanitize all user inputs before PLC operations",
    "access_control": "No authentication in initial version (internal tool)",
    "network_security": "Direct PLC connection, ensure network isolation",
    "error_information": "Limit sensitive information in error messages"
  },

  "deployment_recommendations": {
    "development": {
      "command": "streamlit run streamlit_plc_tester.py --server.port 8501",
      "environment": "Local development with simulation PLC"
    },
    "production": {
      "deployment": "Docker container with PLC network access",
      "configuration": "Environment variables for PLC connection details",
      "monitoring": "System logs integration for operation tracking"
    }
  },

  "future_enhancements": {
    "phase_2_features": [
      "Real-time data visualization with charts",
      "Recipe execution testing interface", 
      "Advanced logging with filtering and search",
      "Configuration backup/restore functionality",
      "Multi-PLC connection support",
      "User authentication and access levels"
    ],
    "integration_opportunities": [
      "Integration with existing ALD recipe system",
      "Connection to Supabase for configuration management",
      "Export test results to database",
      "Integration with system monitoring dashboards"
    ]
  }
}