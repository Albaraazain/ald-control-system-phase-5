# Alerting rules for ALD Control System
# Defines critical alerts for production monitoring

groups:
  - name: ald_control_critical
    interval: 10s
    rules:
      # System Health Alerts
      - alert: ALDControlSystemDown
        expr: up{job="ald-control"} == 0
        for: 30s
        labels:
          severity: critical
          component: system
        annotations:
          summary: "ALD Control System is down"
          description: "The ALD Control System has been down for more than 30 seconds."
          runbook_url: "https://docs.example.com/runbooks/ald-system-down"

      - alert: ALDHealthCheckFailing
        expr: ald_health_status != 1
        for: 1m
        labels:
          severity: critical
          component: health
        annotations:
          summary: "ALD system health check failing"
          description: "ALD system health status is {{ $value }} (should be 1 for healthy)"

      # PLC Connection Alerts
      - alert: PLCConnectionLost
        expr: ald_plc_connected == 0
        for: 2m
        labels:
          severity: critical
          component: plc
        annotations:
          summary: "PLC connection lost"
          description: "PLC connection has been lost for more than 2 minutes"
          runbook_url: "https://docs.example.com/runbooks/plc-connection-lost"

      - alert: PLCErrorRateHigh
        expr: rate(ald_plc_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: plc
        annotations:
          summary: "High PLC error rate"
          description: "PLC error rate is {{ $value }} errors per second over the last 5 minutes"

      # Database Connection Alerts
      - alert: DatabaseConnectionLost
        expr: ald_database_connected == 0
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection lost"
          description: "Database connection has been lost for more than 5 minutes (polling fallback active)"

      # Performance Alerts
      - alert: ParameterLoggingSlowdown
        expr: ald_parameter_logging_interval > 1.5
        for: 3m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "Parameter logging interval exceeding target"
          description: "Parameter logging interval is {{ $value }}s (target: â‰¤1s)"

      - alert: ParameterLoggingCriticalDelay
        expr: ald_parameter_logging_interval > 3.0
        for: 1m
        labels:
          severity: critical
          component: performance
        annotations:
          summary: "Critical parameter logging delay"
          description: "Parameter logging interval is {{ $value }}s (critical threshold: 3s)"

      - alert: HighMemoryUsage
        expr: ald_memory_usage_mb > 400
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}MB (warning threshold: 400MB)"

      - alert: CriticalMemoryUsage
        expr: ald_memory_usage_mb > 800
        for: 1m
        labels:
          severity: critical
          component: resources
        annotations:
          summary: "Critical memory usage"
          description: "Memory usage is {{ $value }}MB (critical threshold: 800MB)"

      # Data Collection Alerts
      - alert: DataCollectionServiceDown
        expr: ald_data_collection_running == 0
        for: 1m
        labels:
          severity: critical
          component: data
        annotations:
          summary: "Data collection service is down"
          description: "Data collection service has been down for more than 1 minute"

      - alert: DataLoggingErrors
        expr: rate(ald_data_logging_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          component: data
        annotations:
          summary: "High data logging error rate"
          description: "Data logging error rate is {{ $value }} errors per second"

  - name: ald_control_warnings
    interval: 30s
    rules:
      # Process State Alerts
      - alert: RecipeExecutionStuck
        expr: ald_current_recipe_duration_seconds > 7200  # 2 hours
        for: 5m
        labels:
          severity: warning
          component: process
        annotations:
          summary: "Recipe execution running for extended time"
          description: "Current recipe has been running for {{ $value }} seconds"

      - alert: CommandQueueBacklog
        expr: ald_command_queue_length > 5
        for: 5m
        labels:
          severity: warning
          component: commands
        annotations:
          summary: "Command queue backlog"
          description: "Command queue has {{ $value }} pending commands"

      # Network Alerts
      - alert: HighNetworkLatency
        expr: ald_plc_response_time_ms > 500
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "High PLC network latency"
          description: "PLC response time is {{ $value }}ms (threshold: 500ms)"

      # Resource Utilization
      - alert: HighCPUUsage
        expr: ald_cpu_usage_percent > 80
        for: 10m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% for more than 10 minutes"

      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "High disk usage"
          description: "Disk usage is {{ $value }}%"

  - name: ald_control_business
    interval: 60s
    rules:
      # Business Logic Alerts
      - alert: ProcessCompletionRateLow
        expr: rate(ald_processes_completed_total[24h]) < rate(ald_processes_started_total[24h]) * 0.95
        for: 1h
        labels:
          severity: warning
          component: business
        annotations:
          summary: "Low process completion rate"
          description: "Process completion rate is below 95% over the last 24 hours"

      - alert: QualityParametersOutOfRange
        expr: ald_quality_parameters_out_of_range > 3
        for: 15m
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "Quality parameters out of range"
          description: "{{ $value }} quality parameters are currently out of acceptable range"

      - alert: MaintenanceWindowApproaching
        expr: (ald_next_maintenance_seconds - time()) < 86400  # 24 hours
        for: 1h
        labels:
          severity: info
          component: maintenance
        annotations:
          summary: "Maintenance window approaching"
          description: "Next scheduled maintenance in {{ $value }} seconds"